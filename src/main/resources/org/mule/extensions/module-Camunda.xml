<?xml version="1.0" encoding="UTF-8"?>
<module name="Camunda Connector"
        prefix="module-camunda"
        doc:description="This module relies in runtime provided components"

        xmlns="http://www.mulesoft.org/schema/mule/module"
        xmlns:mule="http://www.mulesoft.org/schema/mule/core"
        xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
        xmlns:tns="http://www.mulesoft.org/schema/mule/module-camunda"
        xmlns:http="http://www.mulesoft.org/schema/mule/http"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
           http://www.mulesoft.org/schema/mule/module http://www.mulesoft.org/schema/mule/module/current/mule-module.xsd
           http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
           http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
           http://www.mulesoft.org/schema/mule/module-camunda http://www.mulesoft.org/schema/mule/module-camunda/current/mule-module-camunda.xsd">

    <property name="host" type="string" use="REQUIRED" displayName="Host" defaultValue=""
              tab="Camunda Configuration"></property>
    <property name="port" type="string" use="REQUIRED" displayName="Port" defaultValue=""
              tab="Camunda Configuration"></property>
    <property name="username" type="string" use="REQUIRED" displayName="Username" defaultValue=""
              tab="Camunda Configuration"></property>
    <property name="password" type="string" use="REQUIRED" displayName="Password" password="true" defaultValue=""
              tab="Camunda Configuration"></property>

    <http:request-config name="camunda-request-config" basePath="/engine-rest/">
        <http:request-connection host="#[vars.host]" protocol="HTTP" port="#[vars.port]">
            <http:authentication>
                <http:basic-authentication username="#[vars.username]" password="#[vars.password]"/>
            </http:authentication>
        </http:request-connection>
    </http:request-config>

    <operation name="submit-start-form" doc:description="Submit Start Form">
        <parameters>
            <parameter name="id" type="string" use="OPTIONAL" displayName="ID" defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="key" type="string" use="OPTIONAL" displayName="Key" defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="tenantId" type="string" use="OPTIONAL" displayName="Tenant ID" defaultValue=""
                       role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="requestBody" type="string" displayName="Request Body" defaultValue="#[]" role="BEHAVIOUR"
                       tab="General"></parameter>
        </parameters>

        <body>
            <mule:choice>
                <mule:when expression="#[vars.id != null and (sizeOf(trim(vars.id)) > 0)]">
                    <mule:set-variable value="#['process-definition/'++ vars.id ++ '/submit-form']"
                                       doc:name="Request ID" variableName="requestPath"/>
                </mule:when>
                <mule:when expression="#[vars.key != null and (sizeOf(trim(vars.key))> 0)]">
                    <mule:set-variable value="#['process-definition/key/' ++ vars.key ++ '/submit-form']"
                                       doc:name="Request Key"
                                       variableName="requestPath"/>
                </mule:when>
                <mule:otherwise>
                    <mule:set-variable
                            value="['process-definition/key/' ++ vars.key ++ '/tenant-id/' ++ vars.tenantId ++ '/submit-form']"
                            doc:name="Request Tenant ID" variableName="requestPath"/>
                </mule:otherwise>
            </mule:choice>

            <mule:logger level="DEBUG" doc:name="Logger" message="#[vars.requestPath]"/>
            <mule:set-payload value="#[vars.requestBody]"/>
            <http:request config-ref="camunda-request-config" path="#[vars.requestPath]" method="POST"/>
        </body>
        <output type="string" doc:description="Form's output"/>
    </operation>

    <operation name="get-process-definition" doc:description="Get Process Definition">
        <parameters>
            <parameter name="processDefinitionId" type="string" use="OPTIONAL" displayName="Process Definition Id"
                       defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="key" type="string" use="OPTIONAL" displayName="Key" defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
        </parameters>
        <body>
            <mule:choice>
                <mule:when
                        expression="#[vars.processDefinitionId != null and (sizeOf(trim(vars.processDefinitionId)) > 0)]">
                    <mule:set-variable value="#['process-definition?processDefinitionId='++ vars.processDefinitionId]"
                                       doc:name="Get Process By ID" variableName="requestPath"/>
                </mule:when>
                <mule:otherwise>
                    <mule:set-variable value="#['process-definition?key=' ++ vars.key]"
                                       doc:name="Get Process By Key" variableName="requestPath"/>
                </mule:otherwise>
            </mule:choice>
            <http:request config-ref="camunda-request-config" path="#[vars.requestPath]" method="GET"/>
        </body>
        <output type="string" doc:description="Process Definition output"/>
    </operation>

    <operation name="get-task-list" doc:description="Get Task List">
        <parameters>
            <parameter name="processDefinitionId" type="string" use="REQUIRED" displayName="Process Definition Id"
                       defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="firstResult" type="string" use="OPTIONAL" displayName="First Result" defaultValue="1"
                       role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="maxResult" type="string" use="OPTIONAL" displayName="Max Result"
                       defaultValue="10" role="BEHAVIOUR"
                       tab="General"></parameter>
        </parameters>
        <body>
            <mule:set-variable
                    value="#['task?processDefinitionId=' ++ vars.processDefinitionId ++ '&amp;firstResult=' ++ vars.firstResult ++ '&amp;maxResult=' ++ vars.maxResult]"
                    doc:name="Set Request Path" variableName="requestPath"/>
            <http:request config-ref="camunda-request-config" path="#['task?' ++ vars.requestPath]" method="GET"/>
        </body>
        <output type="string" doc:description="Task output"/>
    </operation>

    <operation name="get-task" doc:description="Get Task">
        <parameters>
            <parameter name="taskId" type="string" use="OPTIONAL" displayName="Task Id" defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
        </parameters>
        <body>
            <http:request config-ref="camunda-request-config" path="#['task/' ++ vars.taskId]" method="GET"/>
        </body>
        <output type="string" doc:description="Task output"/>
    </operation>

    <operation name="set-assignee" doc:description="Set Assignee">
        <parameters>
            <parameter name="taskId" type="string" use="REQUIRED" displayName="Task Id" defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
            <parameter name="userId" type="string" use="REQUIRED" displayName="User Id" defaultValue="" role="BEHAVIOUR"
                       tab="General"></parameter>
        </parameters>
        <body>
            <mule:set-payload value="#[%dw 2.0
output application/json
---
{
	'userId': vars.userId
}]"/>
            <http:request config-ref="camunda-request-config" path="#['task/' ++ vars.taskId ++ '/assignee']"
                          method="POST"/>
        </body>
        <output type="string" doc:description="Task output"/>
    </operation>

</module>
